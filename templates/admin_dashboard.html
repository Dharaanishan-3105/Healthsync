{% extends "base.html" %}

{% block title %}Admin Dashboard - HealthSync{% endblock %}
{% block page_title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>System Administration</h2>
    <div>
        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="fas fa-user-plus"></i> Add User
        </button>
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#backupModal">
            <i class="fas fa-database"></i> Create Backup
        </button>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#settingsModal">
            <i class="fas fa-cog"></i> System Settings
        </button>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Total Users</h4>
                        <h2 class="mb-0" id="totalUsersCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Patients</h4>
                        <h2 class="mb-0" id="totalPatientsCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-injured fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Appointments</h4>
                        <h2 class="mb-0" id="totalAppointmentsCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Prescriptions</h4>
                        <h2 class="mb-0" id="totalPrescriptionsCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-pills fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Lab Results</h4>
                        <h2 class="mb-0" id="totalLabResultsCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-flask fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-secondary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Billing</h4>
                        <h2 class="mb-0" id="totalBillingCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-receipt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">User Distribution by Role</h5>
            </div>
            <div class="card-body">
                <canvas id="roleDistributionChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Appointment Status Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="appointmentStatusChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
            <i class="fas fa-users"></i> User Management
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
            <i class="fas fa-chart-line"></i> Analytics
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
            <i class="fas fa-list"></i> System Logs
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="backups-tab" data-bs-toggle="tab" data-bs-target="#backups" type="button" role="tab">
            <i class="fas fa-database"></i> Data Backups
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
            <i class="fas fa-cog"></i> System Settings
        </button>
    </li>
</ul>

<div class="tab-content" id="adminTabContent">
    <!-- User Management Tab -->
    <div class="tab-pane fade show active" id="users" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">User Management</h5>
                <button class="btn btn-primary" onclick="addUser()">
                    <i class="fas fa-plus"></i> Add New User
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="usersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Tab -->
    <div class="tab-pane fade" id="analytics" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Daily Statistics (Last 7 Days)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="dailyStatsChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">System Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="text-center">
                                    <h3 class="text-primary" id="systemUptime">99.9%</h3>
                                    <p class="text-muted">System Uptime</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <h3 class="text-success" id="activeUsers">0</h3>
                                    <p class="text-muted">Active Users</p>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-6">
                                <div class="text-center">
                                    <h3 class="text-info" id="dataSize">0 MB</h3>
                                    <p class="text-muted">Database Size</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <h3 class="text-warning" id="recentActivity">0</h3>
                                    <p class="text-muted">Recent Activity</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Logs Tab -->
    <div class="tab-pane fade" id="logs" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">System Logs</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-control" id="logUserFilter">
                            <option value="">All Users</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="logActionFilter">
                            <option value="">All Actions</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="logDateFilter" placeholder="Date">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="filterLogs()">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover" id="logsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Resource</th>
                                <th>Details</th>
                                <th>IP Address</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <!-- Logs will be populated here -->
                        </tbody>
                    </table>
                </div>
                <nav aria-label="Logs pagination">
                    <ul class="pagination justify-content-center" id="logsPagination">
                        <!-- Pagination will be populated here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Data Backups Tab -->
    <div class="tab-pane fade" id="backups" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Data Backups</h5>
                <button class="btn btn-success" onclick="createBackup()">
                    <i class="fas fa-plus"></i> Create Backup
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="backupsTable">
                        <thead>
                            <tr>
                                <th>Backup Name</th>
                                <th>Type</th>
                                <th>File Size</th>
                                <th>Status</th>
                                <th>Created By</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="backupsTableBody">
                            <!-- Backups will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- System Settings Tab -->
    <div class="tab-pane fade" id="settings" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">System Settings</h5>
                <button class="btn btn-primary" onclick="addSetting()">
                    <i class="fas fa-plus"></i> Add Setting
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="settingsTable">
                        <thead>
                            <tr>
                                <th>Setting Key</th>
                                <th>Value</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Updated By</th>
                                <th>Updated At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="settingsTableBody">
                            <!-- Settings will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label for="userFullName" class="form-label">Full Name *</label>
                        <input type="text" class="form-control" id="userFullName" name="full_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="userEmail" name="email" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="userPassword" class="form-label">Password *</label>
                        <input type="password" class="form-control" id="userPassword" name="password" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="userRole" class="form-label">Role *</label>
                        <select class="form-control" id="userRole" name="role" required>
                            <option value="">Select Role</option>
                            <option value="admin">Admin</option>
                            <option value="doctor">Doctor</option>
                            <option value="nurse">Nurse</option>
                            <option value="receptionist">Receptionist</option>
                            <option value="lab_assistant">Lab Assistant</option>
                            <option value="pharmacy_nurse">Pharmacy Nurse</option>
                            <option value="patient">Patient</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="userPhone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="userPhone" name="phone">
                    </div>
                    
                    <div class="mb-3">
                        <label for="userDepartment" class="form-label">Department</label>
                        <select class="form-control" id="userDepartment" name="department">
                            <option value="">Select Department</option>
                            <option value="Administration">Administration</option>
                            <option value="Cardiology">Cardiology</option>
                            <option value="Pediatrics">Pediatrics</option>
                            <option value="General Medicine">General Medicine</option>
                            <option value="Emergency">Emergency</option>
                            <option value="Surgery">Surgery</option>
                            <option value="Laboratory">Laboratory</option>
                            <option value="Pharmacy">Pharmacy</option>
                            <option value="Reception">Reception</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitUser()">
                    <i class="fas fa-user-plus"></i> Add User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Backup Modal -->
<div class="modal fade" id="backupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Data Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="backupForm">
                    <div class="mb-3">
                        <label for="backupName" class="form-label">Backup Name *</label>
                        <input type="text" class="form-control" id="backupName" name="backup_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="backupType" class="form-label">Backup Type *</label>
                        <select class="form-control" id="backupType" name="backup_type" required>
                            <option value="">Select Type</option>
                            <option value="full">Full Backup</option>
                            <option value="incremental">Incremental Backup</option>
                            <option value="differential">Differential Backup</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="backupNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="backupNotes" name="notes" rows="3" 
                                  placeholder="Optional notes about this backup..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitBackup()">
                    <i class="fas fa-database"></i> Create Backup
                </button>
            </div>
        </div>
    </div>
</div>

<!-- System Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="settingKey" class="form-label">Setting Key *</label>
                                <input type="text" class="form-control" id="settingKey" name="setting_key" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="settingType" class="form-label">Setting Type *</label>
                                <select class="form-control" id="settingType" name="setting_type" required>
                                    <option value="">Select Type</option>
                                    <option value="string">String</option>
                                    <option value="number">Number</option>
                                    <option value="boolean">Boolean</option>
                                    <option value="json">JSON</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="settingValue" class="form-label">Setting Value *</label>
                        <textarea class="form-control" id="settingValue" name="setting_value" rows="3" required 
                                  placeholder="Enter the setting value..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="settingDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="settingDescription" name="description" rows="2" 
                                  placeholder="Describe what this setting controls..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitSetting()">
                    <i class="fas fa-cog"></i> Save Setting
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let analyticsData = null;
let usersData = [];
let logsData = [];
let backupsData = [];
let settingsData = [];

// Load dashboard data
function loadDashboardData() {
    loadAnalytics();
    loadUsers();
    loadLogs();
    loadBackups();
    loadSettings();
}

// Load analytics
function loadAnalytics() {
    fetch('/api/system-analytics')
        .then(response => response.json())
        .then(data => {
            analyticsData = data;
            updateQuickStats(data.overview);
            updateCharts(data);
        })
        .catch(error => {
            console.error('Error loading analytics:', error);
        });
}

// Update quick stats
function updateQuickStats(overview) {
    document.getElementById('totalUsersCount').textContent = overview.total_users;
    document.getElementById('totalPatientsCount').textContent = overview.total_patients;
    document.getElementById('totalAppointmentsCount').textContent = overview.total_appointments;
    document.getElementById('totalPrescriptionsCount').textContent = overview.total_prescriptions;
    document.getElementById('totalLabResultsCount').textContent = overview.total_lab_results;
    document.getElementById('totalBillingCount').textContent = overview.total_billing;
    document.getElementById('recentActivity').textContent = overview.recent_activity;
}

// Update charts
function updateCharts(data) {
    // Role distribution chart
    const roleCtx = document.getElementById('roleDistributionChart').getContext('2d');
    new Chart(roleCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(data.distributions.user_roles),
            datasets: [{
                data: Object.values(data.distributions.user_roles),
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40',
                    '#FF6384'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Appointment status chart
    const appointmentCtx = document.getElementById('appointmentStatusChart').getContext('2d');
    new Chart(appointmentCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(data.distributions.appointment_status),
            datasets: [{
                label: 'Appointments',
                data: Object.values(data.distributions.appointment_status),
                backgroundColor: '#36A2EB'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Daily stats chart
    const dailyCtx = document.getElementById('dailyStatsChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: data.daily_stats.map(stat => stat.date),
            datasets: [{
                label: 'Appointments',
                data: data.daily_stats.map(stat => stat.appointments),
                borderColor: '#36A2EB',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.4
            }, {
                label: 'Prescriptions',
                data: data.daily_stats.map(stat => stat.prescriptions),
                borderColor: '#FF6384',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Load users
function loadUsers() {
    fetch('/api/users')
        .then(response => response.json())
        .then(data => {
            usersData = data;
            displayUsers(data);
        })
        .catch(error => {
            console.error('Error loading users:', error);
        });
}

// Display users
function displayUsers(users) {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';
    
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No users found</td></tr>';
        return;
    }
    
    users.forEach(user => {
        const row = document.createElement('tr');
        const roleClass = user.role === 'admin' ? 'bg-danger' : 
                         user.role === 'doctor' ? 'bg-primary' : 
                         user.role === 'nurse' ? 'bg-info' : 'bg-secondary';
        
        row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.full_name}</td>
            <td>${user.email}</td>
            <td><span class="badge ${roleClass}">${user.role.toUpperCase()}</span></td>
            <td>${user.department || '--'}</td>
            <td>${user.phone || '--'}</td>
            <td><span class="badge bg-success">Active</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Load logs
function loadLogs() {
    fetch('/api/system-logs')
        .then(response => response.json())
        .then(data => {
            logsData = data.logs;
            displayLogs(data.logs);
            updateLogPagination(data);
        })
        .catch(error => {
            console.error('Error loading logs:', error);
        });
}

// Display logs
function displayLogs(logs) {
    const tbody = document.getElementById('logsTableBody');
    tbody.innerHTML = '';
    
    if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No logs found</td></tr>';
        return;
    }
    
    logs.forEach(log => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date(log.created_at).toLocaleString()}</td>
            <td>${log.user_name}</td>
            <td>${log.action}</td>
            <td>${log.resource_type ? log.resource_type + ' #' + log.resource_id : '--'}</td>
            <td>${log.details || '--'}</td>
            <td>${log.ip_address || '--'}</td>
        `;
        tbody.appendChild(row);
    });
}

// Update log pagination
function updateLogPagination(data) {
    const pagination = document.getElementById('logsPagination');
    pagination.innerHTML = '';
    
    for (let i = 1; i <= data.pages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === data.current_page ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="loadLogsPage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
}

// Load backups
function loadBackups() {
    fetch('/api/data-backups')
        .then(response => response.json())
        .then(data => {
            backupsData = data;
            displayBackups(data);
        })
        .catch(error => {
            console.error('Error loading backups:', error);
        });
}

// Display backups
function displayBackups(backups) {
    const tbody = document.getElementById('backupsTableBody');
    tbody.innerHTML = '';
    
    if (backups.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No backups found</td></tr>';
        return;
    }
    
    backups.forEach(backup => {
        const row = document.createElement('tr');
        const statusClass = backup.status === 'completed' ? 'bg-success' : 
                           backup.status === 'in_progress' ? 'bg-warning' : 'bg-danger';
        
        row.innerHTML = `
            <td>${backup.backup_name}</td>
            <td>${backup.backup_type.toUpperCase()}</td>
            <td>${backup.file_size ? (backup.file_size / 1024 / 1024).toFixed(2) + ' MB' : '--'}</td>
            <td><span class="badge ${statusClass}">${backup.status.toUpperCase()}</span></td>
            <td>${backup.created_by}</td>
            <td>${new Date(backup.created_at).toLocaleString()}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewBackup(${backup.id})">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="restoreBackup(${backup.id})">
                    <i class="fas fa-undo"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Load settings
function loadSettings() {
    fetch('/api/hospital-settings')
        .then(response => response.json())
        .then(data => {
            settingsData = data;
            displaySettings(data);
        })
        .catch(error => {
            console.error('Error loading settings:', error);
        });
}

// Display settings
function displaySettings(settings) {
    const tbody = document.getElementById('settingsTableBody');
    tbody.innerHTML = '';
    
    if (settings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No settings found</td></tr>';
        return;
    }
    
    settings.forEach(setting => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${setting.setting_key}</td>
            <td>${setting.setting_value}</td>
            <td><span class="badge bg-info">${setting.setting_type.toUpperCase()}</span></td>
            <td>${setting.description || '--'}</td>
            <td>${setting.updated_by}</td>
            <td>${new Date(setting.updated_at).toLocaleString()}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editSetting(${setting.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSetting(${setting.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Action functions
function addUser() {
    const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
    modal.show();
}

function submitUser() {
    const form = document.getElementById('addUserForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    fetch('/api/users', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.msg) {
            alert('User added successfully!');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
            loadUsers();
        } else {
            alert('Error: ' + result.msg);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function createBackup() {
    const modal = new bootstrap.Modal(document.getElementById('backupModal'));
    modal.show();
}

function submitBackup() {
    const form = document.getElementById('backupForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    fetch('/api/data-backups', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.msg) {
            alert('Backup initiated successfully!');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('backupModal')).hide();
            loadBackups();
        } else {
            alert('Error: ' + result.msg);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function addSetting() {
    const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
    modal.show();
}

function submitSetting() {
    const form = document.getElementById('settingsForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    fetch('/api/hospital-settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.msg) {
            alert('Setting added successfully!');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
            loadSettings();
        } else {
            alert('Error: ' + result.msg);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function editUser(userId) {
    alert('Edit user: ' + userId);
}

function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
        alert('Delete user: ' + userId);
    }
}

function filterLogs() {
    const userFilter = document.getElementById('logUserFilter').value;
    const actionFilter = document.getElementById('logActionFilter').value;
    const dateFilter = document.getElementById('logDateFilter').value;
    
    let url = '/api/system-logs?';
    if (userFilter) url += `user_id=${userFilter}&`;
    if (actionFilter) url += `action=${actionFilter}&`;
    if (dateFilter) url += `start_date=${dateFilter}&`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            logsData = data.logs;
            displayLogs(data.logs);
            updateLogPagination(data);
        })
        .catch(error => {
            console.error('Error filtering logs:', error);
        });
}

function loadLogsPage(page) {
    fetch(`/api/system-logs?page=${page}`)
        .then(response => response.json())
        .then(data => {
            logsData = data.logs;
            displayLogs(data.logs);
            updateLogPagination(data);
        })
        .catch(error => {
            console.error('Error loading logs page:', error);
        });
}

function viewBackup(backupId) {
    alert('View backup: ' + backupId);
}

function restoreBackup(backupId) {
    if (confirm('Are you sure you want to restore this backup?')) {
        alert('Restore backup: ' + backupId);
    }
}

function editSetting(settingId) {
    alert('Edit setting: ' + settingId);
}

function deleteSetting(settingId) {
    if (confirm('Are you sure you want to delete this setting?')) {
        alert('Delete setting: ' + settingId);
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});

// Auto-refresh every 30 seconds
setInterval(loadDashboardData, 30000);
</script>
{% endblock %}
