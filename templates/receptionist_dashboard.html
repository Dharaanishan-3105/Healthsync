{% extends "base.html" %}

{% block title %}Receptionist Dashboard - HealthSync{% endblock %}
{% block page_title %}Receptionist Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Reception Management</h2>
    <div>
        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#registerPatientModal">
            <i class="fas fa-user-plus"></i> Register Patient
        </button>
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#checkInModal">
            <i class="fas fa-sign-in-alt"></i> Check-In Patient
        </button>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#sendNotificationModal">
            <i class="fas fa-bell"></i> Send Notification
        </button>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Today's Appointments</h4>
                        <h2 class="mb-0" id="todayAppointmentsCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-day fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Checked In Today</h4>
                        <h2 class="mb-0" id="checkedInTodayCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Pending Notifications</h4>
                        <h2 class="mb-0" id="pendingNotificationsCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-bell fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Total Patients</h4>
                        <h2 class="mb-0" id="totalPatientsCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="receptionTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#appointments" type="button" role="tab">
            <i class="fas fa-calendar"></i> Appointments
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="checkins-tab" data-bs-toggle="tab" data-bs-target="#checkins" type="button" role="tab">
            <i class="fas fa-sign-in-alt"></i> Check-Ins
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="patients-tab" data-bs-toggle="tab" data-bs-target="#patients" type="button" role="tab">
            <i class="fas fa-users"></i> Patients
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab">
            <i class="fas fa-bell"></i> Notifications
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="billing-tab" data-bs-toggle="tab" data-bs-target="#billing" type="button" role="tab">
            <i class="fas fa-receipt"></i> Billing
        </button>
    </li>
</ul>

<div class="tab-content" id="receptionTabContent">
    <!-- Appointments Tab -->
    <div class="tab-pane fade show active" id="appointments" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Today's Appointments</h5>
                <div>
                    <button class="btn btn-sm btn-primary" onclick="scheduleAppointment()">
                        <i class="fas fa-plus"></i> Schedule Appointment
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="appointmentsTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Patient</th>
                                <th>Doctor</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="appointmentsTableBody">
                            <!-- Appointments will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Check-Ins Tab -->
    <div class="tab-pane fade" id="checkins" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Patient Check-Ins</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="checkinsTable">
                        <thead>
                            <tr>
                                <th>Check-In Time</th>
                                <th>Patient</th>
                                <th>Appointment</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="checkinsTableBody">
                            <!-- Check-ins will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Patients Tab -->
    <div class="tab-pane fade" id="patients" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Patient Records</h5>
                <div>
                    <button class="btn btn-sm btn-primary" onclick="registerNewPatient()">
                        <i class="fas fa-user-plus"></i> Register New Patient
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="patientsTable">
                        <thead>
                            <tr>
                                <th>Patient ID</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Gender</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="patientsTableBody">
                            <!-- Patients will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Tab -->
    <div class="tab-pane fade" id="notifications" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Patient Notifications</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="notificationsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Patient</th>
                                <th>Type</th>
                                <th>Title</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="notificationsTableBody">
                            <!-- Notifications will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Billing Tab -->
    <div class="tab-pane fade" id="billing" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Billing Management</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="billingTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Patient</th>
                                <th>Service</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="billingTableBody">
                            <!-- Billing records will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Register Patient Modal -->
<div class="modal fade" id="registerPatientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Register New Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerPatientForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientName" class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="patientName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="patientEmail" name="email">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientPhone" class="form-label">Phone *</label>
                                <input type="tel" class="form-control" id="patientPhone" name="phone" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientAge" class="form-label">Age *</label>
                                <input type="number" class="form-control" id="patientAge" name="age" required min="0" max="120">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientGender" class="form-label">Gender *</label>
                                <select class="form-control" id="patientGender" name="gender" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientDob" class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="patientDob" name="date_of_birth">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="patientAddress" class="form-label">Address</label>
                        <textarea class="form-control" id="patientAddress" name="address" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientInsurance" class="form-label">Insurance Provider</label>
                                <select class="form-control" id="patientInsurance" name="insurance_provider">
                                    <option value="">Select Insurance</option>
                                    <option value="Blue Cross">Blue Cross</option>
                                    <option value="Aetna">Aetna</option>
                                    <option value="Cigna">Cigna</option>
                                    <option value="Medicare">Medicare</option>
                                    <option value="Medicaid">Medicaid</option>
                                    <option value="None">None</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientEmergencyContact" class="form-label">Emergency Contact</label>
                                <input type="text" class="form-control" id="patientEmergencyContact" name="emergency_contact">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="registerPatient()">
                    <i class="fas fa-user-plus"></i> Register Patient
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Check-In Modal -->
<div class="modal fade" id="checkInModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Patient Check-In</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="checkInForm">
                    <div class="mb-3">
                        <label for="checkInPatient" class="form-label">Patient *</label>
                        <select class="form-control" id="checkInPatient" name="patient_id" required onchange="loadPatientAppointments()">
                            <option value="">Select Patient</option>
                            {% for patient in patients %}
                            <option value="{{ patient.id }}">{{ patient.patient_id }} - {{ patient.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="checkInAppointment" class="form-label">Appointment (Optional)</label>
                        <select class="form-control" id="checkInAppointment" name="appointment_id">
                            <option value="">Select Appointment</option>
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="checkInDepartment" class="form-label">Department</label>
                                <select class="form-control" id="checkInDepartment" name="department">
                                    <option value="">Select Department</option>
                                    <option value="General">General</option>
                                    <option value="Cardiology">Cardiology</option>
                                    <option value="Pediatrics">Pediatrics</option>
                                    <option value="Emergency">Emergency</option>
                                    <option value="Surgery">Surgery</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="checkInStatus" class="form-label">Status</label>
                                <select class="form-control" id="checkInStatus" name="status">
                                    <option value="checked_in">Checked In</option>
                                    <option value="waiting">Waiting</option>
                                    <option value="in_consultation">In Consultation</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="checkInNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="checkInNotes" name="notes" rows="3" 
                                  placeholder="Any special notes for this check-in..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="checkInPatient()">
                    <i class="fas fa-sign-in-alt"></i> Check-In Patient
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Send Notification Modal -->
<div class="modal fade" id="sendNotificationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Patient Notification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="notificationForm">
                    <div class="mb-3">
                        <label for="notificationPatient" class="form-label">Patient *</label>
                        <select class="form-control" id="notificationPatient" name="patient_id" required>
                            <option value="">Select Patient</option>
                            {% for patient in patients %}
                            <option value="{{ patient.id }}">{{ patient.patient_id }} - {{ patient.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="notificationType" class="form-label">Notification Type *</label>
                                <select class="form-control" id="notificationType" name="notification_type" required>
                                    <option value="">Select Type</option>
                                    <option value="appointment_reminder">Appointment Reminder</option>
                                    <option value="appointment_update">Appointment Update</option>
                                    <option value="billing">Billing</option>
                                    <option value="general">General</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="notificationTitle" class="form-label">Title *</label>
                                <input type="text" class="form-control" id="notificationTitle" name="title" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notificationMessage" class="form-label">Message *</label>
                        <textarea class="form-control" id="notificationMessage" name="message" rows="4" required 
                                  placeholder="Enter the notification message..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="sendNotification()">
                    <i class="fas fa-bell"></i> Send Notification
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let appointmentsData = [];
let checkinsData = [];
let patientsData = [];
let notificationsData = [];
let billingData = [];

// Load dashboard data
function loadDashboardData() {
    loadAppointments();
    loadCheckIns();
    loadPatients();
    loadNotifications();
    loadBilling();
    updateQuickStats();
}

// Load appointments
function loadAppointments() {
    const today = new Date().toISOString().split('T')[0];
    fetch(`/api/appointments?date=${today}`)
        .then(response => response.json())
        .then(data => {
            appointmentsData = data;
            displayAppointments(data);
        })
        .catch(error => {
            console.error('Error loading appointments:', error);
        });
}

// Display appointments
function displayAppointments(appointments) {
    const tbody = document.getElementById('appointmentsTableBody');
    tbody.innerHTML = '';
    
    if (appointments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No appointments for today</td></tr>';
        return;
    }
    
    appointments.forEach(appointment => {
        const row = document.createElement('tr');
        const statusClass = appointment.status === 'scheduled' ? 'bg-primary' : 
                           appointment.status === 'completed' ? 'bg-success' : 'bg-warning';
        
        row.innerHTML = `
            <td>${new Date(appointment.appointment_time).toLocaleTimeString()}</td>
            <td>${appointment.patient_name}</td>
            <td>${appointment.doctor_name}</td>
            <td>${appointment.department || '--'}</td>
            <td><span class="badge ${statusClass}">${appointment.status.toUpperCase()}</span></td>
            <td>
                <button class="btn btn-sm btn-success" onclick="checkInFromAppointment(${appointment.id})">
                    <i class="fas fa-sign-in-alt"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="rescheduleAppointment(${appointment.id})">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Load check-ins
function loadCheckIns() {
    const today = new Date().toISOString().split('T')[0];
    fetch(`/api/patient-checkin?date=${today}`)
        .then(response => response.json())
        .then(data => {
            checkinsData = data;
            displayCheckIns(data);
        })
        .catch(error => {
            console.error('Error loading check-ins:', error);
        });
}

// Display check-ins
function displayCheckIns(checkins) {
    const tbody = document.getElementById('checkinsTableBody');
    tbody.innerHTML = '';
    
    if (checkins.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No check-ins for today</td></tr>';
        return;
    }
    
    checkins.forEach(checkin => {
        const row = document.createElement('tr');
        const statusClass = checkin.status === 'checked_in' ? 'bg-primary' : 
                           checkin.status === 'waiting' ? 'bg-warning' : 
                           checkin.status === 'in_consultation' ? 'bg-info' : 'bg-success';
        
        row.innerHTML = `
            <td>${new Date(checkin.check_in_time).toLocaleString()}</td>
            <td>${checkin.patient_name}</td>
            <td>${checkin.appointment_id ? 'Appointment #' + checkin.appointment_id : 'Walk-in'}</td>
            <td>${checkin.department || '--'}</td>
            <td><span class="badge ${statusClass}">${checkin.status.replace('_', ' ').toUpperCase()}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="updateCheckInStatus(${checkin.id})">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Load patients
function loadPatients() {
    fetch('/api/patients')
        .then(response => response.json())
        .then(data => {
            patientsData = data;
            displayPatients(data);
        })
        .catch(error => {
            console.error('Error loading patients:', error);
        });
}

// Display patients
function displayPatients(patients) {
    const tbody = document.getElementById('patientsTableBody');
    tbody.innerHTML = '';
    
    if (patients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No patients found</td></tr>';
        return;
    }
    
    patients.forEach(patient => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${patient.patient_id}</td>
            <td>${patient.name}</td>
            <td>${patient.phone || '--'}</td>
            <td>${patient.email || '--'}</td>
            <td>${patient.gender || '--'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewPatientDetails(${patient.id})">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="editPatient(${patient.id})">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Load notifications
function loadNotifications() {
    fetch('/api/patient-notifications')
        .then(response => response.json())
        .then(data => {
            notificationsData = data;
            displayNotifications(data);
        })
        .catch(error => {
            console.error('Error loading notifications:', error);
        });
}

// Display notifications
function displayNotifications(notifications) {
    const tbody = document.getElementById('notificationsTableBody');
    tbody.innerHTML = '';
    
    if (notifications.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No notifications found</td></tr>';
        return;
    }
    
    notifications.forEach(notification => {
        const row = document.createElement('tr');
        const statusClass = notification.status === 'sent' ? 'bg-success' : 
                           notification.status === 'delivered' ? 'bg-info' : 'bg-warning';
        
        row.innerHTML = `
            <td>${new Date(notification.created_at).toLocaleDateString()}</td>
            <td>${notification.patient_name}</td>
            <td>${notification.notification_type.replace('_', ' ').toUpperCase()}</td>
            <td>${notification.title}</td>
            <td><span class="badge ${statusClass}">${notification.status.toUpperCase()}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewNotificationDetails(${notification.id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Load billing
function loadBilling() {
    fetch('/api/billing')
        .then(response => response.json())
        .then(data => {
            billingData = data;
            displayBilling(data);
        })
        .catch(error => {
            console.error('Error loading billing:', error);
        });
}

// Display billing
function displayBilling(billing) {
    const tbody = document.getElementById('billingTableBody');
    tbody.innerHTML = '';
    
    if (billing.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No billing records found</td></tr>';
        return;
    }
    
    billing.forEach(bill => {
        const row = document.createElement('tr');
        const statusClass = bill.status === 'paid' ? 'bg-success' : 
                           bill.status === 'pending' ? 'bg-warning' : 'bg-danger';
        
        row.innerHTML = `
            <td>${new Date(bill.created_at).toLocaleDateString()}</td>
            <td>${bill.patient_name}</td>
            <td>${bill.service_type}</td>
            <td>$${bill.amount}</td>
            <td><span class="badge ${statusClass}">${bill.status.toUpperCase()}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewBillingDetails(${bill.id})">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="generateReceipt(${bill.id})">
                    <i class="fas fa-receipt"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Update quick stats
function updateQuickStats() {
    document.getElementById('todayAppointmentsCount').textContent = appointmentsData.length;
    document.getElementById('checkedInTodayCount').textContent = checkinsData.length;
    document.getElementById('pendingNotificationsCount').textContent = notificationsData.filter(n => n.status === 'pending').length;
    document.getElementById('totalPatientsCount').textContent = patientsData.length;
}

// Load patient appointments for check-in
function loadPatientAppointments() {
    const patientId = document.getElementById('checkInPatient').value;
    const appointmentSelect = document.getElementById('checkInAppointment');
    
    appointmentSelect.innerHTML = '<option value="">Select Appointment</option>';
    
    if (!patientId) return;
    
    const patientAppointments = appointmentsData.filter(apt => apt.patient_id == patientId);
    patientAppointments.forEach(appointment => {
        const option = document.createElement('option');
        option.value = appointment.id;
        option.textContent = `${new Date(appointment.appointment_time).toLocaleString()} - ${appointment.doctor_name}`;
        appointmentSelect.appendChild(option);
    });
}

// Register patient
async function registerPatient() {
    const form = document.getElementById('registerPatientForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/api/patients', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('Patient registered successfully!');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('registerPatientModal')).hide();
            loadPatients(); // Refresh patients
            updateQuickStats(); // Update stats
        } else {
            alert('Error: ' + result.msg);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Check-in patient
async function checkInPatient() {
    const form = document.getElementById('checkInForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/api/patient-checkin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('Patient checked in successfully!');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('checkInModal')).hide();
            loadCheckIns(); // Refresh check-ins
            updateQuickStats(); // Update stats
        } else {
            alert('Error: ' + result.msg);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Send notification
async function sendNotification() {
    const form = document.getElementById('notificationForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/api/patient-notifications', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('Notification sent successfully!');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('sendNotificationModal')).hide();
            loadNotifications(); // Refresh notifications
            updateQuickStats(); // Update stats
        } else {
            alert('Error: ' + result.msg);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Action functions
function scheduleAppointment() {
    window.location.href = '/appointments';
}

function registerNewPatient() {
    const modal = new bootstrap.Modal(document.getElementById('registerPatientModal'));
    modal.show();
}

function checkInFromAppointment(appointmentId) {
    const appointment = appointmentsData.find(apt => apt.id === appointmentId);
    if (appointment) {
        document.getElementById('checkInPatient').value = appointment.patient_id;
        loadPatientAppointments();
        document.getElementById('checkInAppointment').value = appointmentId;
        const modal = new bootstrap.Modal(document.getElementById('checkInModal'));
        modal.show();
    }
}

function rescheduleAppointment(appointmentId) {
    alert('Reschedule appointment: ' + appointmentId);
}

function updateCheckInStatus(checkinId) {
    alert('Update check-in status: ' + checkinId);
}

function viewPatientDetails(patientId) {
    alert('View patient details: ' + patientId);
}

function editPatient(patientId) {
    alert('Edit patient: ' + patientId);
}

function viewNotificationDetails(notificationId) {
    alert('View notification details: ' + notificationId);
}

function viewBillingDetails(billId) {
    alert('View billing details: ' + billId);
}

function generateReceipt(billId) {
    alert('Generate receipt: ' + billId);
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});

// Auto-refresh every 30 seconds
setInterval(loadDashboardData, 30000);
</script>
{% endblock %}
