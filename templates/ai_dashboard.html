{% extends "base.html" %}

{% block title %}AI Dashboard - HealthSync{% endblock %}
{% block page_title %}AI Dashboard{% endblock %}

{% block content %}
<!-- Floating AI Chatbot -->
<div id="floatingChatbot" class="floating-chatbot">
    <div id="chatbotToggle" class="chatbot-toggle">
        <i class="fas fa-robot"></i>
        <span class="chatbot-badge" id="messageBadge">0</span>
    </div>
    <div id="chatbotWindow" class="chatbot-window">
        <div class="chatbot-header">
            <div class="d-flex align-items-center">
                <div class="chatbot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="chatbot-info">
                    <h6 class="mb-0">HealthSync AI</h6>
                    <small class="text-muted">Smart Health Assistant</small>
                </div>
            </div>
            <div class="chatbot-controls">
                <button class="btn btn-sm btn-outline-secondary" id="minimizeChatbot">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" id="closeChatbot">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="chatbot-body">
            <div id="floatingChatContainer" class="chat-messages">
                <div class="message bot-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <p>Hello! I'm your HealthSync website assistant. I can help you with:</p>
                            <ul class="mb-0">
                                <li>Website navigation and features</li>
                                <li>Appointment scheduling help</li>
                                <li>Prescription management guide</li>
                                <li>User role permissions</li>
                                <li>Dashboard functionality</li>
                                <li>Billing and payment features</li>
                            </ul>
                            <p class="mb-0">What HealthSync feature do you need help with? ðŸ¤–</p>
                        </div>
                        <small class="message-time">Just now</small>
                    </div>
                </div>
            </div>
            <div class="chatbot-input">
                <div class="input-group">
                    <input type="text" class="form-control" id="floatingChatInput" 
                           placeholder="Ask me about HealthSync features..." 
                           onkeypress="handleFloatingChatKeyPress(event)">
                    <button class="btn btn-primary" onclick="sendFloatingMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="quick-actions mt-2">
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="sendQuickMessage('How to book an appointment?')">
                        Book Appointment
                    </button>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="sendQuickMessage('How to manage prescriptions?')">
                        Prescriptions
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="sendQuickMessage('What can I do in my dashboard?')">
                        Dashboard Help
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>AI-Powered Analytics & Intelligence</h2>
    <div>
        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#predictiveModal">
            <i class="fas fa-brain"></i> Generate Prediction
        </button>
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#smartSchedulingModal">
            <i class="fas fa-calendar-check"></i> Smart Scheduling
        </button>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#chatbotModal">
            <i class="fas fa-robot"></i> AI Chatbot
        </button>
    </div>
</div>

<!-- AI Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">AI Predictions</h4>
                        <h2 class="mb-0" id="aiPredictionsCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-brain fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Smart Schedules</h4>
                        <h2 class="mb-0" id="smartSchedulesCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-check fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Chat Sessions</h4>
                        <h2 class="mb-0" id="chatSessionsCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-robot fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">AI Accuracy</h4>
                        <h2 class="mb-0" id="aiAccuracy">94.2%</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="aiTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="predictive-tab" data-bs-toggle="tab" data-bs-target="#predictive" type="button" role="tab">
            <i class="fas fa-brain"></i> Predictive Analytics
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="scheduling-tab" data-bs-toggle="tab" data-bs-target="#scheduling" type="button" role="tab">
            <i class="fas fa-calendar-check"></i> Smart Scheduling
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="chatbot-tab" data-bs-toggle="tab" data-bs-target="#chatbot" type="button" role="tab">
            <i class="fas fa-robot"></i> AI Chatbot
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="insights-tab" data-bs-toggle="tab" data-bs-target="#insights" type="button" role="tab">
            <i class="fas fa-lightbulb"></i> AI Insights
        </button>
    </li>
</ul>

<div class="tab-content" id="aiTabContent">
    <!-- Predictive Analytics Tab -->
    <div class="tab-pane fade show active" id="predictive" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Predictive Analytics</h5>
                <button class="btn btn-primary" onclick="generatePrediction()">
                    <i class="fas fa-plus"></i> Generate New Prediction
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="predictionsTable">
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Prediction Type</th>
                                <th>Risk Level</th>
                                <th>Confidence</th>
                                <th>Recommendations</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="predictionsTableBody">
                            <!-- Predictions will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Scheduling Tab -->
    <div class="tab-pane fade" id="scheduling" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Smart Scheduling</h5>
                <button class="btn btn-success" onclick="createSmartSchedule()">
                    <i class="fas fa-plus"></i> Create Smart Schedule
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="schedulesTable">
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Doctor</th>
                                <th>Urgency</th>
                                <th>Priority Score</th>
                                <th>AI Confidence</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="schedulesTableBody">
                            <!-- Schedules will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chatbot Tab -->
    <div class="tab-pane fade" id="chatbot" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">AI Chatbot</h5>
            </div>
            <div class="card-body">
                <div class="chat-container" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; margin-bottom: 1rem;" id="chatContainer">
                    <div class="text-center text-muted">
                        <i class="fas fa-robot fa-2x mb-2"></i>
                        <p>Start a conversation with our AI assistant</p>
                    </div>
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="chatInput" placeholder="Type your message here..." onkeypress="handleChatKeyPress(event)">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Insights Tab -->
    <div class="tab-pane fade" id="insights" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Risk Analysis</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="riskAnalysisChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">AI Performance</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="aiPerformanceChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">AI Recommendations</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="aiRecommendations">
                            <!-- AI recommendations will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Predictive Analytics Modal -->
<div class="modal fade" id="predictiveModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate AI Prediction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="predictiveForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="predictionPatient" class="form-label">Patient *</label>
                                <select class="form-control" id="predictionPatient" name="patient_id" required>
                                    <option value="">Select Patient</option>
                                    <!-- Patients will be populated here -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="predictionType" class="form-label">Prediction Type *</label>
                                <select class="form-control" id="predictionType" name="prediction_type" required>
                                    <option value="">Select Type</option>
                                    <option value="readmission_risk">Readmission Risk</option>
                                    <option value="disease_progression">Disease Progression</option>
                                    <option value="treatment_outcome">Treatment Outcome</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="predictionSymptoms" class="form-label">Symptoms</label>
                        <textarea class="form-control" id="predictionSymptoms" name="symptoms" rows="3" 
                                  placeholder="Enter patient symptoms (comma-separated)..."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="predictionVitals" class="form-label">Vital Signs</label>
                                <textarea class="form-control" id="predictionVitals" name="vitals" rows="3" 
                                          placeholder="Enter vital signs (JSON format)..."></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="predictionHistory" class="form-label">Medical History</label>
                                <textarea class="form-control" id="predictionHistory" name="history" rows="3" 
                                          placeholder="Enter medical history..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="predictionRiskFactors" class="form-label">Risk Factors</label>
                        <textarea class="form-control" id="predictionRiskFactors" name="risk_factors" rows="2" 
                                  placeholder="Enter risk factors (comma-separated)..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitPrediction()">
                    <i class="fas fa-brain"></i> Generate Prediction
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Smart Scheduling Modal -->
<div class="modal fade" id="smartSchedulingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Smart Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="smartSchedulingForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="schedulePatient" class="form-label">Patient *</label>
                                <select class="form-control" id="schedulePatient" name="patient_id" required>
                                    <option value="">Select Patient</option>
                                    <!-- Patients will be populated here -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleDoctor" class="form-label">Doctor *</label>
                                <select class="form-control" id="scheduleDoctor" name="doctor_id" required>
                                    <option value="">Select Doctor</option>
                                    <!-- Doctors will be populated here -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleUrgency" class="form-label">Urgency Level *</label>
                                <select class="form-control" id="scheduleUrgency" name="urgency_level" required>
                                    <option value="">Select Urgency</option>
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="schedulePriority" class="form-label">Priority Score</label>
                                <input type="number" class="form-control" id="schedulePriority" name="priority_score" 
                                       min="0" max="1" step="0.1" value="0.7">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scheduleReason" class="form-label">Scheduling Reason</label>
                        <textarea class="form-control" id="scheduleReason" name="scheduling_reason" rows="3" 
                                  placeholder="Enter reason for smart scheduling..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitSmartSchedule()">
                    <i class="fas fa-calendar-check"></i> Create Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Chatbot Modal -->
<div class="modal fade" id="chatbotModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI Chatbot Assistant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="chat-container" style="height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; margin-bottom: 1rem;" id="modalChatContainer">
                    <div class="text-center text-muted">
                        <i class="fas fa-robot fa-2x mb-2"></i>
                        <p>Ask me about HealthSync features and functionality</p>
                    </div>
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="modalChatInput" placeholder="Ask about HealthSync features..." onkeypress="handleModalChatKeyPress(event)">
                    <button class="btn btn-primary" onclick="sendModalMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Floating Chatbot Styles */
.floating-chatbot {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.chatbot-toggle {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    position: relative;
    animation: pulse 2s infinite;
}

.chatbot-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
}

.chatbot-toggle i {
    color: white;
    font-size: 24px;
}

.chatbot-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    animation: bounce 1s infinite;
}

.chatbot-window {
    position: absolute;
    bottom: 70px;
    right: 0;
    width: 350px;
    height: 500px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    display: none;
    flex-direction: column;
    overflow: hidden;
    animation: slideUp 0.3s ease;
}

.chatbot-window.show {
    display: flex;
}

.chatbot-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chatbot-avatar {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
}

.chatbot-avatar i {
    font-size: 18px;
}

.chatbot-info h6 {
    margin: 0;
    font-weight: 600;
}

.chatbot-controls button {
    margin-left: 5px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
}

.chatbot-controls button:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
}

.chatbot-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #f8f9fa;
}

.chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    max-height: 350px;
}

.message {
    display: flex;
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease;
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    flex-shrink: 0;
}

.bot-message .message-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.user-message .message-avatar {
    background: #007bff;
    color: white;
}

.message-content {
    flex: 1;
    max-width: 80%;
}

.message-bubble {
    background: white;
    padding: 12px 15px;
    border-radius: 18px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    position: relative;
}

.bot-message .message-bubble {
    background: white;
    border-bottom-left-radius: 5px;
}

.user-message .message-bubble {
    background: #007bff;
    color: white;
    border-bottom-right-radius: 5px;
    margin-left: auto;
}

.user-message {
    flex-direction: row-reverse;
}

.user-message .message-avatar {
    margin-right: 0;
    margin-left: 10px;
}

.message-time {
    color: #6c757d;
    font-size: 11px;
    margin-top: 5px;
    display: block;
}

.chatbot-input {
    padding: 15px;
    background: white;
    border-top: 1px solid #e9ecef;
}

.quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.quick-actions .btn {
    font-size: 11px;
    padding: 4px 8px;
}

/* Animations */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-3px); }
    60% { transform: translateY(-2px); }
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .chatbot-window {
        width: 300px;
        height: 400px;
    }
    
    .floating-chatbot {
        bottom: 10px;
        right: 10px;
    }
}

/* Custom Scrollbar */
.chat-messages::-webkit-scrollbar {
    width: 4px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 2px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentChatSession = null;
let predictionsData = [];
let schedulesData = [];

// Load AI dashboard data
function loadAIDashboardData() {
    loadPredictions();
    loadSchedules();
    loadAIInsights();
    updateAIStats();
}

// Load predictions
function loadPredictions() {
    fetch('/api/predictive-analytics')
        .then(response => response.json())
        .then(data => {
            predictionsData = data;
            displayPredictions(data);
        })
        .catch(error => {
            console.error('Error loading predictions:', error);
        });
}

// Display predictions
function displayPredictions(predictions) {
    const tbody = document.getElementById('predictionsTableBody');
    tbody.innerHTML = '';
    
    if (predictions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No predictions found</td></tr>';
        return;
    }
    
    predictions.forEach(prediction => {
        const row = document.createElement('tr');
        const riskClass = prediction.risk_level === 'high' ? 'bg-danger' : 
                         prediction.risk_level === 'medium' ? 'bg-warning' : 'bg-success';
        
        row.innerHTML = `
            <td>${prediction.patient_name}</td>
            <td>${prediction.prediction_type.replace('_', ' ').toUpperCase()}</td>
            <td><span class="badge ${riskClass}">${prediction.risk_level.toUpperCase()}</span></td>
            <td>${(prediction.confidence_score * 100).toFixed(1)}%</td>
            <td>${prediction.recommendations || '--'}</td>
            <td>${new Date(prediction.created_at).toLocaleDateString()}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewPrediction(${prediction.id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Load schedules
function loadSchedules() {
    fetch('/api/smart-scheduling')
        .then(response => response.json())
        .then(data => {
            schedulesData = data;
            displaySchedules(data);
        })
        .catch(error => {
            console.error('Error loading schedules:', error);
        });
}

// Display schedules
function displaySchedules(schedules) {
    const tbody = document.getElementById('schedulesTableBody');
    tbody.innerHTML = '';
    
    if (schedules.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No schedules found</td></tr>';
        return;
    }
    
    schedules.forEach(schedule => {
        const row = document.createElement('tr');
        const urgencyClass = schedule.urgency_level === 'urgent' ? 'bg-danger' : 
                           schedule.urgency_level === 'high' ? 'bg-warning' : 'bg-info';
        
        row.innerHTML = `
            <td>${schedule.patient_name}</td>
            <td>${schedule.doctor_name}</td>
            <td><span class="badge ${urgencyClass}">${schedule.urgency_level.toUpperCase()}</span></td>
            <td>${(schedule.priority_score * 100).toFixed(1)}%</td>
            <td>${(schedule.ai_confidence * 100).toFixed(1)}%</td>
            <td><span class="badge bg-primary">${schedule.status.toUpperCase()}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-success" onclick="acceptSchedule(${schedule.id})">
                    <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="rejectSchedule(${schedule.id})">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Load AI insights
function loadAIInsights() {
    // Risk analysis chart
    const riskCtx = document.getElementById('riskAnalysisChart').getContext('2d');
    new Chart(riskCtx, {
        type: 'doughnut',
        data: {
            labels: ['Low Risk', 'Medium Risk', 'High Risk', 'Critical Risk'],
            datasets: [{
                data: [45, 30, 20, 5],
                backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // AI performance chart
    const performanceCtx = document.getElementById('aiPerformanceChart').getContext('2d');
    new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Prediction Accuracy',
                data: [85, 87, 89, 91, 93, 94],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }, {
                label: 'Scheduling Efficiency',
                data: [78, 82, 85, 88, 90, 92],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // AI recommendations
    const recommendations = [
        {
            title: "Optimize Appointment Scheduling",
            description: "AI suggests implementing dynamic scheduling based on patient urgency and doctor availability.",
            priority: "high",
            impact: "15% efficiency improvement"
        },
        {
            title: "Enhanced Risk Prediction",
            description: "Consider integrating additional patient data sources for more accurate predictions.",
            priority: "medium",
            impact: "8% accuracy improvement"
        },
        {
            title: "Chatbot Training",
            description: "Update chatbot responses based on recent patient interactions and feedback.",
            priority: "low",
            impact: "Better patient satisfaction"
        }
    ];

    const recommendationsContainer = document.getElementById('aiRecommendations');
    recommendationsContainer.innerHTML = '';

    recommendations.forEach(rec => {
        const priorityClass = rec.priority === 'high' ? 'border-danger' : 
                             rec.priority === 'medium' ? 'border-warning' : 'border-info';
        
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-3';
        col.innerHTML = `
            <div class="card ${priorityClass}">
                <div class="card-body">
                    <h6 class="card-title">${rec.title}</h6>
                    <p class="card-text">${rec.description}</p>
                    <small class="text-muted">Impact: ${rec.impact}</small>
                </div>
            </div>
        `;
        recommendationsContainer.appendChild(col);
    });
}

// Update AI stats
function updateAIStats() {
    document.getElementById('aiPredictionsCount').textContent = predictionsData.length;
    document.getElementById('smartSchedulesCount').textContent = schedulesData.length;
    document.getElementById('chatSessionsCount').textContent = '12'; // Mock data
}

// Chatbot functions
function initializeChatbot() {
    fetch('/api/chatbot', {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
    })
    .then(response => response.json())
    .then(data => {
        currentChatSession = data.session_id;
        addChatMessage('bot', 'Hello! I\'m your AI assistant. How can I help you today?');
    })
    .catch(error => {
        console.error('Error initializing chatbot:', error);
    });
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    addChatMessage('user', message);
    input.value = '';
    
    // Send to API
    fetch('/api/chatbot', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
            session_id: currentChatSession,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        addChatMessage('bot', data.response);
    })
    .catch(error => {
        addChatMessage('bot', 'Sorry, I encountered an error. Please try again.');
    });
}

function addChatMessage(type, message) {
    const container = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-2 ${type === 'user' ? 'text-end' : 'text-start'}`;
    
    const badgeClass = type === 'user' ? 'bg-primary' : 'bg-secondary';
    messageDiv.innerHTML = `
        <span class="badge ${badgeClass} p-2">
            ${message}
        </span>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// Modal chatbot functions
function sendModalMessage() {
    const input = document.getElementById('modalChatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    addModalChatMessage('user', message);
    input.value = '';
    
    // Send to API
    fetch('/api/chatbot', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
            session_id: currentChatSession,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        addModalChatMessage('bot', data.response);
    })
    .catch(error => {
        addModalChatMessage('bot', 'Sorry, I encountered an error. Please try again.');
    });
}

function addModalChatMessage(type, message) {
    const container = document.getElementById('modalChatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-2 ${type === 'user' ? 'text-end' : 'text-start'}`;
    
    const badgeClass = type === 'user' ? 'bg-primary' : 'bg-secondary';
    messageDiv.innerHTML = `
        <span class="badge ${badgeClass} p-2">
            ${message}
        </span>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

function handleModalChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendModalMessage();
    }
}

// Action functions
function generatePrediction() {
    const modal = new bootstrap.Modal(document.getElementById('predictiveModal'));
    modal.show();
}

function submitPrediction() {
    const form = document.getElementById('predictiveForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Convert comma-separated strings to arrays
    if (data.symptoms) data.symptoms = data.symptoms.split(',').map(s => s.trim());
    if (data.risk_factors) data.risk_factors = data.risk_factors.split(',').map(r => r.trim());
    
    fetch('/api/predictive-analytics', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.msg) {
            alert('Prediction generated successfully!');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('predictiveModal')).hide();
            loadPredictions();
        } else {
            alert('Error: ' + result.msg);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function createSmartSchedule() {
    const modal = new bootstrap.Modal(document.getElementById('smartSchedulingModal'));
    modal.show();
}

function submitSmartSchedule() {
    const form = document.getElementById('smartSchedulingForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    fetch('/api/smart-scheduling', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.msg) {
            alert('Smart schedule created successfully!');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('smartSchedulingModal')).hide();
            loadSchedules();
        } else {
            alert('Error: ' + result.msg);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function viewPrediction(predictionId) {
    alert('View prediction: ' + predictionId);
}

function acceptSchedule(scheduleId) {
    if (confirm('Accept this smart schedule suggestion?')) {
        alert('Schedule accepted: ' + scheduleId);
    }
}

function rejectSchedule(scheduleId) {
    if (confirm('Reject this smart schedule suggestion?')) {
        alert('Schedule rejected: ' + scheduleId);
    }
}

// Floating Chatbot Functions
let isChatbotOpen = false;
let messageCount = 0;

// Initialize floating chatbot
function initializeFloatingChatbot() {
    const toggle = document.getElementById('chatbotToggle');
    const window = document.getElementById('chatbotWindow');
    const closeBtn = document.getElementById('closeChatbot');
    const minimizeBtn = document.getElementById('minimizeChatbot');
    
    toggle.addEventListener('click', function() {
        if (isChatbotOpen) {
            window.classList.remove('show');
            isChatbotOpen = false;
        } else {
            window.classList.add('show');
            isChatbotOpen = true;
            messageCount = 0;
            updateMessageBadge();
        }
    });
    
    closeBtn.addEventListener('click', function() {
        window.classList.remove('show');
        isChatbotOpen = false;
    });
    
    minimizeBtn.addEventListener('click', function() {
        window.classList.remove('show');
        isChatbotOpen = false;
    });
    
    // Initialize chatbot session
    initializeChatbot();
}

// Send floating message
function sendFloatingMessage() {
    const input = document.getElementById('floatingChatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    addFloatingMessage('user', message);
    input.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send to API
    fetch('/api/chatbot', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
            session_id: currentChatSession,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        hideTypingIndicator();
        addFloatingMessage('bot', data.response);
    })
    .catch(error => {
        hideTypingIndicator();
        addFloatingMessage('bot', 'Sorry, I encountered an error. Please try again.');
    });
}

// Send quick message
function sendQuickMessage(message) {
    addFloatingMessage('user', message);
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send to API
    fetch('/api/chatbot', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
            session_id: currentChatSession,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        hideTypingIndicator();
        addFloatingMessage('bot', data.response);
    })
    .catch(error => {
        hideTypingIndicator();
        addFloatingMessage('bot', 'Sorry, I encountered an error. Please try again.');
    });
}

// Add floating message
function addFloatingMessage(type, message) {
    const container = document.getElementById('floatingChatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const avatar = type === 'user' ? 'fas fa-user' : 'fas fa-robot';
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="${avatar}"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                ${formatMessage(message)}
            </div>
            <small class="message-time">${time}</small>
        </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
    
    // Update message count
    if (type === 'user') {
        messageCount++;
        updateMessageBadge();
    }
}

// Format message with proper line breaks and styling
function formatMessage(message) {
    // Convert line breaks to HTML
    message = message.replace(/\n/g, '<br>');
    
    // Convert **text** to bold
    message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Convert *text* to italic
    message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Convert bullet points
    message = message.replace(/â€¢ /g, '<br>â€¢ ');
    
    return message;
}

// Show typing indicator
function showTypingIndicator() {
    const container = document.getElementById('floatingChatContainer');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message typing-indicator';
    typingDiv.id = 'typingIndicator';
    
    typingDiv.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(typingDiv);
    container.scrollTop = container.scrollHeight;
}

// Hide typing indicator
function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Handle floating chat key press
function handleFloatingChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendFloatingMessage();
    }
}

// Update message badge
function updateMessageBadge() {
    const badge = document.getElementById('messageBadge');
    if (messageCount > 0) {
        badge.textContent = messageCount;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}

// Add typing indicator styles
const typingStyles = `
<style>
.typing-indicator .message-bubble {
    background: #e9ecef;
    color: #6c757d;
}

.typing-dots {
    display: flex;
    align-items: center;
    gap: 4px;
}

.typing-dots span {
    width: 6px;
    height: 6px;
    background: #6c757d;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}
</style>
`;

// Add typing styles to head
document.head.insertAdjacentHTML('beforeend', typingStyles);

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAIDashboardData();
    initializeFloatingChatbot();
});
</script>
{% endblock %}
