{% extends "base.html" %}

{% block title %}Laboratory Dashboard - HealthSync{% endblock %}
{% block page_title %}Laboratory Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Laboratory Management</h2>
    <div>
        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#uploadResultModal">
            <i class="fas fa-upload"></i> Upload Results
        </button>
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addInventoryModal">
            <i class="fas fa-plus"></i> Add Inventory
        </button>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#scheduleTestModal">
            <i class="fas fa-calendar"></i> Schedule Test
        </button>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Pending Requests</h4>
                        <h2 class="mb-0" id="pendingRequestsCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clipboard-list fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Urgent Tests</h4>
                        <h2 class="mb-0" id="urgentTestsCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Results Today</h4>
                        <h2 class="mb-0" id="resultsTodayCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-flask fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">Low Stock Items</h4>
                        <h2 class="mb-0" id="lowStockCount">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-boxes fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="labTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="requests-tab" data-bs-toggle="tab" data-bs-target="#requests" type="button" role="tab">
            <i class="fas fa-clipboard-list"></i> Lab Requests
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" type="button" role="tab">
            <i class="fas fa-flask"></i> Test Results
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">
            <i class="fas fa-boxes"></i> Lab Inventory
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
            <i class="fas fa-file-medical"></i> Reports
        </button>
    </li>
</ul>

<div class="tab-content" id="labTabContent">
    <!-- Lab Requests Tab -->
    <div class="tab-pane fade show active" id="requests" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Lab Test Requests</h5>
                <div>
                    <button class="btn btn-sm btn-warning me-2" onclick="filterUrgentRequests()">
                        <i class="fas fa-exclamation-triangle"></i> Show Urgent
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="clearRequestFilter()">
                        <i class="fas fa-times"></i> Clear Filter
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="requestsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Patient</th>
                                <th>Test Name</th>
                                <th>Test Type</th>
                                <th>Priority</th>
                                <th>Doctor</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <!-- Requests will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Results Tab -->
    <div class="tab-pane fade" id="results" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Test Results</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="resultsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Patient</th>
                                <th>Test Name</th>
                                <th>Test Type</th>
                                <th>Status</th>
                                <th>Uploaded By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Lab Inventory Tab -->
    <div class="tab-pane fade" id="inventory" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Laboratory Inventory</h5>
                <div>
                    <button class="btn btn-sm btn-warning me-2" onclick="filterLowStock()">
                        <i class="fas fa-exclamation-triangle"></i> Show Low Stock
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="clearInventoryFilter()">
                        <i class="fas fa-times"></i> Clear Filter
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Location</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <!-- Inventory will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-pane fade" id="reports" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Laboratory Reports</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-bar fa-3x text-primary mb-3"></i>
                                <h5>Test Volume Report</h5>
                                <p class="text-muted">Generate reports on test volumes and trends</p>
                                <button class="btn btn-primary" onclick="generateTestVolumeReport()">
                                    <i class="fas fa-download"></i> Generate
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                                <h5>Turnaround Time Report</h5>
                                <p class="text-muted">Analyze test completion times</p>
                                <button class="btn btn-warning" onclick="generateTurnaroundReport()">
                                    <i class="fas fa-download"></i> Generate
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-boxes fa-3x text-info mb-3"></i>
                                <h5>Inventory Report</h5>
                                <p class="text-muted">Track inventory levels and usage</p>
                                <button class="btn btn-info" onclick="generateInventoryReport()">
                                    <i class="fas fa-download"></i> Generate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Result Modal -->
<div class="modal fade" id="uploadResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Test Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadResultForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="resultPatient" class="form-label">Patient *</label>
                                <select class="form-control" id="resultPatient" name="patient_id" required>
                                    <option value="">Select Patient</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.id }}">{{ patient.patient_id }} - {{ patient.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="testName" class="form-label">Test Name *</label>
                                <input type="text" class="form-control" id="testName" name="test_name" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="testType" class="form-label">Test Type *</label>
                                <select class="form-control" id="testType" name="test_type" required>
                                    <option value="">Select Test Type</option>
                                    <option value="blood_test">Blood Test</option>
                                    <option value="urinalysis">Urinalysis</option>
                                    <option value="imaging">Imaging</option>
                                    <option value="microbiology">Microbiology</option>
                                    <option value="chemistry">Chemistry</option>
                                    <option value="hematology">Hematology</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="resultStatus" class="form-label">Status</label>
                                <select class="form-control" id="resultStatus" name="status">
                                    <option value="completed">Completed</option>
                                    <option value="pending">Pending Review</option>
                                    <option value="abnormal">Abnormal</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="testResults" class="form-label">Test Results *</label>
                        <textarea class="form-control" id="testResults" name="results" rows="4" required 
                                  placeholder="Enter detailed test results..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="resultFile" class="form-label">Upload File (Optional)</label>
                        <input type="file" class="form-control" id="resultFile" name="file" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        <small class="form-text text-muted">Supported formats: PDF, JPG, PNG, DOC, DOCX</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadTestResult()">
                    <i class="fas fa-upload"></i> Upload Results
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Inventory Modal -->
<div class="modal fade" id="addInventoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Laboratory Inventory Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="inventoryForm">
                    <div class="mb-3">
                        <label for="inventoryItemName" class="form-label">Item Name *</label>
                        <input type="text" class="form-control" id="inventoryItemName" name="item_name" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inventoryItemType" class="form-label">Item Type *</label>
                                <select class="form-control" id="inventoryItemType" name="item_type" required>
                                    <option value="">Select Type</option>
                                    <option value="equipment">Equipment</option>
                                    <option value="supplies">Supplies</option>
                                    <option value="reagents">Reagents</option>
                                    <option value="consumables">Consumables</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inventoryQuantity" class="form-label">Quantity *</label>
                                <input type="number" class="form-control" id="inventoryQuantity" name="quantity" required min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inventoryUnit" class="form-label">Unit</label>
                                <select class="form-control" id="inventoryUnit" name="unit">
                                    <option value="pieces">Pieces</option>
                                    <option value="boxes">Boxes</option>
                                    <option value="bottles">Bottles</option>
                                    <option value="ml">ML</option>
                                    <option value="mg">MG</option>
                                    <option value="units">Units</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inventoryLocation" class="form-label">Location</label>
                                <input type="text" class="form-control" id="inventoryLocation" name="location" placeholder="e.g., Lab Room A, Shelf 2">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inventoryExpiry" class="form-label">Expiry Date</label>
                                <input type="date" class="form-control" id="inventoryExpiry" name="expiry_date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inventorySupplier" class="form-label">Supplier</label>
                                <input type="text" class="form-control" id="inventorySupplier" name="supplier">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="inventoryStatus" class="form-label">Status</label>
                        <select class="form-control" id="inventoryStatus" name="status">
                            <option value="available">Available</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="out_of_order">Out of Order</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="addInventoryItem()">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Test Modal -->
<div class="modal fade" id="scheduleTestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule Lab Test</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleTestForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="schedulePatient" class="form-label">Patient *</label>
                                <select class="form-control" id="schedulePatient" name="patient_id" required>
                                    <option value="">Select Patient</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.id }}">{{ patient.patient_id }} - {{ patient.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleTestName" class="form-label">Test Name *</label>
                                <input type="text" class="form-control" id="scheduleTestName" name="test_name" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduleTestType" class="form-label">Test Type *</label>
                                <select class="form-control" id="scheduleTestType" name="test_type" required>
                                    <option value="">Select Test Type</option>
                                    <option value="blood_test">Blood Test</option>
                                    <option value="urinalysis">Urinalysis</option>
                                    <option value="imaging">Imaging</option>
                                    <option value="microbiology">Microbiology</option>
                                    <option value="chemistry">Chemistry</option>
                                    <option value="hematology">Hematology</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="schedulePriority" class="form-label">Priority</label>
                                <select class="form-control" id="schedulePriority" name="priority">
                                    <option value="normal">Normal</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scheduleDate" class="form-label">Scheduled Date & Time *</label>
                        <input type="datetime-local" class="form-control" id="scheduleDate" name="scheduled_date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scheduleInstructions" class="form-label">Instructions</label>
                        <textarea class="form-control" id="scheduleInstructions" name="instructions" rows="3" 
                                  placeholder="Special instructions for the test..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="scheduleTest()">
                    <i class="fas fa-calendar"></i> Schedule Test
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let requestsData = [];
let resultsData = [];
let inventoryData = [];

// Load dashboard data
function loadDashboardData() {
    loadLabRequests();
    loadTestResults();
    loadLaboratoryInventory();
    updateQuickStats();
}

// Load lab requests
function loadLabRequests() {
    fetch('/api/lab-requests')
        .then(response => response.json())
        .then(data => {
            requestsData = data;
            displayLabRequests(data);
        })
        .catch(error => {
            console.error('Error loading lab requests:', error);
        });
}

// Display lab requests
function displayLabRequests(requests) {
    const tbody = document.getElementById('requestsTableBody');
    tbody.innerHTML = '';
    
    if (requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No lab requests found</td></tr>';
        return;
    }
    
    requests.forEach(request => {
        const row = document.createElement('tr');
        const priorityClass = request.priority === 'urgent' ? 'bg-danger' : 
                             request.priority === 'high' ? 'bg-warning' : 'bg-info';
        const statusClass = request.status === 'completed' ? 'bg-success' : 
                           request.status === 'in_progress' ? 'bg-primary' : 'bg-secondary';
        
        row.innerHTML = `
            <td>${new Date(request.created_at).toLocaleDateString()}</td>
            <td>${request.patient_name}</td>
            <td>${request.test_name}</td>
            <td>${request.test_type.replace('_', ' ').toUpperCase()}</td>
            <td><span class="badge ${priorityClass}">${request.priority.toUpperCase()}</span></td>
            <td>${request.doctor_name}</td>
            <td><span class="badge ${statusClass}">${request.status.replace('_', ' ').toUpperCase()}</span></td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="updateRequestStatus(${request.id}, 'in_progress')">
                    <i class="fas fa-play"></i>
                </button>
                <button class="btn btn-sm btn-success" onclick="updateRequestStatus(${request.id}, 'completed')">
                    <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="viewRequestDetails(${request.id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Load test results
function loadTestResults() {
    fetch('/api/lab-results')
        .then(response => response.json())
        .then(data => {
            resultsData = data;
            displayTestResults(data);
        })
        .catch(error => {
            console.error('Error loading test results:', error);
        });
}

// Display test results
function displayTestResults(results) {
    const tbody = document.getElementById('resultsTableBody');
    tbody.innerHTML = '';
    
    if (results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No test results found</td></tr>';
        return;
    }
    
    results.forEach(result => {
        const row = document.createElement('tr');
        const statusClass = result.status === 'completed' ? 'bg-success' : 
                           result.status === 'abnormal' ? 'bg-danger' : 'bg-warning';
        
        row.innerHTML = `
            <td>${new Date(result.created_at).toLocaleDateString()}</td>
            <td>${result.patient_name}</td>
            <td>${result.test_name}</td>
            <td>${result.test_type ? result.test_type.replace('_', ' ').toUpperCase() : '--'}</td>
            <td><span class="badge ${statusClass}">${result.status.toUpperCase()}</span></td>
            <td>${result.uploaded_by || '--'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewResultDetails(${result.id})">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="downloadResult(${result.id})">
                    <i class="fas fa-download"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Load laboratory inventory
function loadLaboratoryInventory() {
    fetch('/api/laboratory-inventory')
        .then(response => response.json())
        .then(data => {
            inventoryData = data;
            displayLaboratoryInventory(data);
        })
        .catch(error => {
            console.error('Error loading laboratory inventory:', error);
        });
}

// Display laboratory inventory
function displayLaboratoryInventory(inventory) {
    const tbody = document.getElementById('inventoryTableBody');
    tbody.innerHTML = '';
    
    if (inventory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No inventory items found</td></tr>';
        return;
    }
    
    inventory.forEach(item => {
        const row = document.createElement('tr');
        const isLowStock = item.quantity <= 5;
        const statusClass = item.status === 'available' ? 'bg-success' : 
                           item.status === 'maintenance' ? 'bg-warning' : 'bg-danger';
        
        row.innerHTML = `
            <td>${item.item_name}</td>
            <td>${item.item_type.charAt(0).toUpperCase() + item.item_type.slice(1)}</td>
            <td>${item.quantity}</td>
            <td>${item.unit || '--'}</td>
            <td>${item.location || '--'}</td>
            <td><span class="badge ${statusClass}">${item.status.replace('_', ' ').toUpperCase()}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editInventoryItem(${item.id})">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Update quick stats
function updateQuickStats() {
    document.getElementById('pendingRequestsCount').textContent = requestsData.filter(r => r.status === 'requested').length;
    document.getElementById('urgentTestsCount').textContent = requestsData.filter(r => r.priority === 'urgent').length;
    
    const today = new Date().toISOString().split('T')[0];
    const resultsToday = resultsData.filter(r => r.created_at.startsWith(today)).length;
    document.getElementById('resultsTodayCount').textContent = resultsToday;
    
    document.getElementById('lowStockCount').textContent = inventoryData.filter(item => item.quantity <= 5).length;
}

// Upload test result
async function uploadTestResult() {
    const form = document.getElementById('uploadResultForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/api/lab-results', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: formData
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('Test results uploaded successfully!');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('uploadResultModal')).hide();
            loadTestResults(); // Refresh results
            updateQuickStats(); // Update stats
        } else {
            alert('Error: ' + result.msg);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Add inventory item
async function addInventoryItem() {
    const form = document.getElementById('inventoryForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/api/laboratory-inventory', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('Inventory item added successfully!');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('addInventoryModal')).hide();
            loadLaboratoryInventory(); // Refresh inventory
            updateQuickStats(); // Update stats
        } else {
            alert('Error: ' + result.msg);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Schedule test
async function scheduleTest() {
    const form = document.getElementById('scheduleTestForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/api/lab-requests', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('Test scheduled successfully!');
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('scheduleTestModal')).hide();
            loadLabRequests(); // Refresh requests
            updateQuickStats(); // Update stats
        } else {
            alert('Error: ' + result.msg);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Update request status
async function updateRequestStatus(requestId, newStatus) {
    try {
        const response = await fetch('/api/lab-requests', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify({
                id: requestId,
                status: newStatus
            })
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('Request status updated successfully!');
            loadLabRequests(); // Refresh requests
            updateQuickStats(); // Update stats
        } else {
            alert('Error: ' + result.msg);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Filter functions
function filterUrgentRequests() {
    const urgentRequests = requestsData.filter(request => request.priority === 'urgent');
    displayLabRequests(urgentRequests);
}

function clearRequestFilter() {
    displayLabRequests(requestsData);
}

function filterLowStock() {
    const lowStockItems = inventoryData.filter(item => item.quantity <= 5);
    displayLaboratoryInventory(lowStockItems);
}

function clearInventoryFilter() {
    displayLaboratoryInventory(inventoryData);
}

// Report generation functions
function generateTestVolumeReport() {
    alert('Generating test volume report...');
    // Implementation for generating test volume report
}

function generateTurnaroundReport() {
    alert('Generating turnaround time report...');
    // Implementation for generating turnaround report
}

function generateInventoryReport() {
    alert('Generating inventory report...');
    // Implementation for generating inventory report
}

// View details functions
function viewRequestDetails(requestId) {
    alert('View request details: ' + requestId);
}

function viewResultDetails(resultId) {
    alert('View result details: ' + resultId);
}

function downloadResult(resultId) {
    alert('Download result: ' + resultId);
}

function editInventoryItem(itemId) {
    alert('Edit inventory item: ' + itemId);
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    
    // Set default date to now for scheduling
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('scheduleDate').value = localDateTime;
});

// Auto-refresh every 30 seconds
setInterval(loadDashboardData, 30000);
</script>
{% endblock %}
